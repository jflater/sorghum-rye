---
title: "Figure 3: Drainage with Plot-Level Uncertainty"
format: html
execute:
  warning: false
  message: false
  echo: true
---

```{r setup}
library(tidyverse)
library(lubridate)
library(patchwork)
library(janitor)

# Theme and color utilities
theme_publication <- function(base_size = 12) {
  theme_minimal(base_size = base_size) +
    theme(
      panel.background = element_rect(fill = "#ffffffff", color = NA),
      plot.background = element_rect(fill = "#ffffffff", color = NA),
      panel.grid.major = element_line(color = alpha("#B7B5B3", 0.2)),
      panel.grid.minor = element_blank(),
      text = element_text(color = "#000000ff"),
      axis.text = element_text(color = "#000000ff"),
      strip.background = element_rect(fill = alpha("#A5CAD2", 0.2)),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing = unit(2, "lines")
    )
}

treatment_colors <- c(
  "Sorghum" = "#D8D97AFF",
  "Sorghum + Rye" = "#95C36EFF",
  "Corn" = "#74C8C3FF",
  "Soy" = "#0A2E57FF"
)

scale_color_treatments <- function() scale_color_manual(values = treatment_colors)
scale_fill_treatments <- function() scale_fill_manual(values = treatment_colors)
```

## Data Import

```{r data-import}
leaching_data <- read_csv("data/clean_leaching.csv") %>%
  clean_names() %>%
  mutate(date = as.Date(date), year = year(date)) %>%
  filter(year %in% c(2023, 2024), !is.na(year))

rain <- readxl::read_xlsx("data/rain/historical_rain.xlsx") %>%
  select(day, doy, precipmm) %>%
  mutate(date = as.Date(day), year = year(date))
```

## Daily Leaching and Plot-Level Cumulative Curves

```{r leaching-cumulative}
# Plot area conversion (from Final_Figures_Tables.qmd)
plot_area_ft2 <- 120 * 160
plot_area_ha <- plot_area_ft2 / 107639.1041671

# Plot-level daily losses

daily_leaching <- leaching_data %>%
  filter(treatment %in% c("Sorghum", "Sorghum + Rye")) %>%
  mutate(daily_n_loss_kgha = (total_n_loss_mg / 1e6) / plot_area_ha) %>%
  group_by(plot, treatment, year, date) %>%
  summarise(daily_loss = mean(daily_n_loss_kgha, na.rm = TRUE), .groups = "drop") %>%
  arrange(plot, treatment, year, date)

# Treatment-level daily summary for top panel

daily_leaching_summary <- daily_leaching %>%
  group_by(treatment, year, date) %>%
  summarise(
    mean_loss = mean(daily_loss, na.rm = TRUE),
    se_loss = sd(daily_loss, na.rm = TRUE) / sqrt(sum(!is.na(daily_loss))),
    .groups = "drop"
  )

# Measurement windows based on observed data
leaching_date_ranges <- leaching_data %>%
  filter(treatment %in% c("Sorghum", "Sorghum + Rye"), !is.na(total_n_loss_mg)) %>%
  group_by(year) %>%
  summarise(
    min_date = min(date, na.rm = TRUE),
    max_date = max(date, na.rm = TRUE),
    .groups = "drop"
  )

# Plot-level interpolation and cumulative sums
cum_leaching_plot_level <- daily_leaching %>%
  arrange(treatment, year, plot, date) %>%
  group_by(treatment, year, plot) %>%
  group_modify(~ {
    df <- .x %>%
      complete(date = seq(min(date), max(date), by = "day")) %>%
      arrange(date)

    non_na <- !is.na(df$daily_loss)
    if (sum(non_na) == 0) return(tibble())

    loss_interp <- if (sum(non_na) >= 2) {
      approx(
        x = df$date[non_na],
        y = df$daily_loss[non_na],
        xout = df$date,
        rule = 1,
        ties = "ordered"
      )$y
    } else {
      rep(df$daily_loss[non_na][1], nrow(df))
    }

    df %>%
      mutate(
        loss_interp = loss_interp,
        cum_loss = cumsum(loss_interp)
      ) %>%
      filter(!is.na(loss_interp))
  }) %>%
  ungroup()

# Between-plot summary with 95% CI ribbons
cum_leaching_summary <- cum_leaching_plot_level %>%
  group_by(treatment, year, date) %>%
  summarise(
    cum_loss_mean = mean(cum_loss, na.rm = TRUE),
    cum_loss_sd   = sd(cum_loss, na.rm = TRUE),
    n_plots       = dplyr::n(),
    cum_loss_se   = cum_loss_sd / sqrt(n_plots),
    t_crit        = ifelse(n_plots > 1, qt(0.975, df = n_plots - 1), NA_real_),
    cum_loss_ci   = t_crit * cum_loss_se,
    .groups = "drop"
  )

# Observed cumulative points for reference
obs_points <- daily_leaching %>%
  group_by(treatment, year) %>%
  arrange(date) %>%
  mutate(cum_obs = cumsum(replace_na(daily_loss, 0))) %>%
  ungroup()
```

## Panels

```{r panels}
# Precipitation aligned to leaching measurement window
daily_precip_leaching <- rain %>%
  transmute(date, year, precipmm) %>%
  filter(year %in% c(2023, 2024)) %>%
  left_join(leaching_date_ranges, by = "year") %>%
  filter(date >= min_date, date <= max_date) %>%
  select(date, year, precipmm)

# Monthly leaching bars (matches original layout)
monthly_leaching_faceted <- daily_leaching_summary %>%
  mutate(month_year = floor_date(date, "month")) %>%
  group_by(treatment, year, month_year) %>%
  summarise(
    monthly_total = sum(mean_loss, na.rm = TRUE),
    monthly_se = sqrt(sum(se_loss^2, na.rm = TRUE)),
    .groups = "drop"
  )

monthly_plot <- ggplot(monthly_leaching_faceted, aes(x = month_year, y = monthly_total, fill = treatment)) +
  geom_col(position = position_dodge(width = 20), width = 15) +
  geom_errorbar(aes(ymin = pmax(monthly_total - monthly_se, 0), ymax = monthly_total + monthly_se),
                position = position_dodge(width = 20), width = 5) +
  scale_fill_treatments() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  labs(y = expression("Monthly N Loss (kg N ha"^-1*")"), fill = "Treatment") +
  facet_wrap(~year, nrow = 1, scales = "free_x") +
  theme_publication() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none"
  ) +
  labs(x = "")

# Cumulative leaching with plot-level CI
cumulative_leaching_plot <- ggplot(cum_leaching_summary,
                                   aes(x = date, y = cum_loss_mean,
                                       color = treatment, fill = treatment)) +
  geom_ribbon(aes(ymin = pmax(cum_loss_mean - cum_loss_ci, 0),
                  ymax = cum_loss_mean + cum_loss_ci),
              alpha = 0.2, linewidth = 0) +
  geom_line(linewidth = 1.1) +
  geom_point(data = obs_points, inherit.aes = FALSE,
             aes(x = date, y = cum_obs, color = treatment),
             alpha = 0.5, shape = 16, size = 1.2) +
  scale_color_treatments() +
  scale_fill_treatments() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  labs(x = "Month",
       y = expression("Cumulative N Loss (kg N ha"^-1*")"),
       color = "Treatment", fill = "Treatment") +
  facet_wrap(~year, nrow = 1, scales = "free_x") +
  theme_publication() +
  theme(
    strip.text = element_blank(),
    legend.position = "bottom",
    legend.direction = "horizontal",
    strip.background = element_rect(fill = alpha("#A5CAD2", 0.2)),
    panel.spacing = unit(2, "lines")
  )

# Dual-axis daily + cumulative panels (matches Figure 2 styling)
global_max_loss <- max(daily_leaching_summary$mean_loss + daily_leaching_summary$se_loss, na.rm = TRUE)
global_max_precip <- max(daily_precip_leaching$precipmm, na.rm = TRUE)
global_max_cum_loss <- max(cum_leaching_summary$cum_loss_mean + cum_leaching_summary$cum_loss_ci, na.rm = TRUE)

# Scale precipitation to "rain down" from the top of the daily loss axis
global_precip_scale_factor <- global_max_loss * 0.4 / global_max_precip
global_plot_top <- global_max_loss * 1.1

create_dual_axis_leaching_plot <- function(year_val, is_right_panel = FALSE) {
  leaching_year <- daily_leaching_summary %>% filter(year == year_val)
  precip_year <- daily_precip_leaching %>% filter(year == year_val)
  cum_leach_year <- cum_leaching_summary %>% filter(year == year_val)
  obs_year <- obs_points %>% filter(year == year_val)

  year_limits <- leaching_date_ranges %>% filter(year == year_val)
  year_start <- year_limits$min_date
  year_end   <- year_limits$max_date

  daily_plot <- ggplot() +
    geom_rect(data = precip_year,
              aes(xmin = date - 0.5, xmax = date + 0.5,
                  ymin = global_plot_top - precipmm * global_precip_scale_factor, ymax = global_plot_top),
              fill = "#377EB8", alpha = 0.7) +
    geom_point(data = leaching_year,
               aes(x = date, y = mean_loss, color = treatment),
               size = 2) +
    geom_errorbar(data = leaching_year,
                  aes(x = date, ymin = mean_loss - se_loss, ymax = mean_loss + se_loss, color = treatment),
                  width = 0.2, alpha = 0.5) +
    scale_color_treatments() +
    guides(color = "none") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b",
                 limits = c(year_start, year_end)) +
    scale_y_continuous(
      name = if (!is_right_panel) expression("Daily N Loss (kg N ha"^-1*" day"^-1*")") else "",
      limits = c(0, global_plot_top),
      sec.axis = sec_axis(~ (global_plot_top - .) / global_precip_scale_factor,
                          name = if (is_right_panel) "Daily Precipitation (mm)" else "")
    ) +
    theme_publication() +
    theme(
      legend.position = "none",
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.y = if (is_right_panel) element_blank() else element_text(),
      axis.ticks.y = if (is_right_panel) element_blank() else element_line(),
      axis.title.y = if (is_right_panel) element_blank() else element_text(),
      axis.text.y.right = if (is_right_panel) element_text(color = "#377EB8") else element_blank(),
      axis.ticks.y.right = if (is_right_panel) element_line() else element_blank(),
      axis.title.y.right = if (is_right_panel) element_text(color = "#377EB8") else element_blank()
    ) +
    labs(title = paste("", year_val), x = "") +
    geom_hline(yintercept = 0, linetype = "solid", alpha = 0.3)

  cumulative_plot <- ggplot(cum_leach_year,
                            aes(x = date, y = cum_loss_mean, color = treatment, fill = treatment)) +
    geom_ribbon(aes(ymin = pmax(cum_loss_mean - cum_loss_ci, 0),
                    ymax = cum_loss_mean + cum_loss_ci),
                alpha = 0.2, linewidth = 0) +
    geom_line(linewidth = 1.1) +
    geom_point(data = obs_year, inherit.aes = FALSE,
               aes(x = date, y = cum_obs, color = treatment),
               alpha = 0.5, shape = 16, size = 1.2) +
    scale_color_treatments() +
    scale_fill_treatments() +
    scale_x_date(date_breaks = "1 month", date_labels = "%b",
                 limits = c(year_start, year_end)) +
    scale_y_continuous(
      name = if (!is_right_panel) expression("Cumulative N Loss (kg N ha"^-1*")") else "",
      limits = c(0, global_max_cum_loss)
    ) +
    labs(x = "Month") +
    theme_publication() +
    theme(
      legend.position = "none",
      axis.text.y = if (is_right_panel) element_blank() else element_text(),
      axis.ticks.y = if (is_right_panel) element_blank() else element_line(),
      axis.title.y = if (is_right_panel) element_blank() else element_text()
    )

  (daily_plot / cumulative_plot) +
    patchwork::plot_layout(heights = c(1.2, 1))
}
library(patchwork)
plot_leaching_2023 <- create_dual_axis_leaching_plot(2023, is_right_panel = FALSE)
plot_leaching_2024 <- create_dual_axis_leaching_plot(2024, is_right_panel = TRUE)

figure3_plotlevel <- (plot_leaching_2023 | plot_leaching_2024) +
  patchwork::plot_layout(guides = "collect") &
  theme(legend.position = "bottom",
        legend.justification = "center",
        legend.box.just = "center")

figure3_plotlevel
```

## Export Figure

```{r save-figure, echo=FALSE}
ggsave(
  filename = "figures/figure3_leaching_cumulative_plotlevelCI.png",
  plot     = figure3_plotlevel,
  width    = 174,
  height   = 174,
  units    = "mm",
  dpi      = 600,
  bg       = "white"
)
```