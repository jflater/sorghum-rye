---
title: "Figure 3: Drainage/Leaching with Plot-Level Cumulative Uncertainty"
format: 
  html:
    toc: true
    code-fold: true
    embed-resources: true
execute:
  echo: true
  warning: false
  message: false
  error: false
---

# Overview

This document reproduces Figure 3 (daily nitrogen leaching and cumulative N loss) using
a more statistically appropriate uncertainty method: plot-level cumulative curves with
between-plot variability ribbons (95% CI from between-plot variability).

```{r setup}
#| label: setup
#| message: false
#| warning: false

# Load required packages
library(tidyverse)
library(lubridate)
library(patchwork)
library(readxl)

# Re-establish dplyr preferences after loading packages
if (requireNamespace("conflicted", quietly = TRUE)) {
  library(conflicted)
  conflicts_prefer(dplyr::select)
  conflicts_prefer(dplyr::filter)
  conflicts_prefer(dplyr::summarise)
}

# Custom theme for consistency (from Final_Figures_Tables.qmd)
theme_publication <- function(base_size = 12) {
  theme_minimal(base_size = base_size) +
    theme(
      panel.background = element_rect(fill = "#ffffffff", color = NA),
      plot.background = element_rect(fill = "#ffffffff", color = NA),
      panel.grid.major = element_line(color = alpha("#B7B5B3", 0.2)),
      panel.grid.minor = element_blank(),
      text = element_text(color = "#000000ff"),
      axis.text = element_text(color = "#000000ff"),
      strip.background = element_rect(fill = alpha("#A5CAD2", 0.2)),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing = unit(2, "lines")
    )
}

# Treatment colors (from Final_Figures_Tables.qmd)
treatment_colors <- c(
  "Sorghum" = "#D8D97AFF",
  "Sorghum + Rye" = "#95C36EFF", 
  "Corn" = "#74C8C3FF",
  "Soy" = "#0A2E57FF"
)

scale_color_treatments <- function() scale_color_manual(values = treatment_colors)
scale_fill_treatments <- function() scale_fill_manual(values = treatment_colors)
```

# Data Import

```{r data-import}
#| label: data-import
#| message: false

# Analysis years (centralized for maintainability)
analysis_years <- c(2023, 2024)

# Import leaching data
leaching_data <- read_csv("data/clean_leaching.csv") %>%
  janitor::clean_names() %>%
  mutate(
    date = as.Date(date),
    year = year(date)
  ) %>%
  filter(year %in% analysis_years) %>%
  filter(!is.na(year))

# Import precipitation data
rain <- read_xlsx("data/rain/historical_rain.xlsx")

rain <- rain %>%
  select(day, doy, precipmm) %>%
  mutate(
    date = as.Date(day),
    year = year(date)
  ) %>%
  group_by(year) %>%
  arrange(date) %>%
  mutate(cumulative_precip = cumsum(precipmm))

rain <- rain %>%
  mutate(doy_date = as.Date(doy - 1, origin = "2000-01-01"))

# Plot area conversion
plot_area_ft2 <- 120 * 160
plot_area_ha <- plot_area_ft2 / 107639.1041671
```

# Plot-Level Cumulative Leaching Computation

The key improvement here is computing cumulative N loss at the **plot level** first,
then summarizing across plots to get between-plot variability for the 95% CI ribbons.

```{r plot-level-cumulative}
#| label: plot-level-cumulative

# Step 1: Compute daily N loss at the plot level (kg N ha-1 day-1)
daily_leaching_plot <- leaching_data %>%
  filter(treatment %in% c("Sorghum", "Sorghum + Rye")) %>%
  mutate(
    daily_n_loss_kgha = (total_n_loss_mg / 1e6) / plot_area_ha
  ) %>%
  group_by(plot, treatment, year, date) %>%
  summarise(
    daily_loss = mean(daily_n_loss_kgha, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(treatment, year, plot, date)

# Step 2: Get measurement date ranges for each year
leaching_date_ranges <- daily_leaching_plot %>%
  filter(!is.na(daily_loss) & daily_loss > 0) %>%
  group_by(year) %>%
  summarise(
    min_date = min(date, na.rm = TRUE),
    max_date = max(date, na.rm = TRUE),
    .groups = "drop"
  )

cat("Leaching measurement date ranges:\n")
print(leaching_date_ranges)

# Step 3: Interpolate daily losses and compute cumulative loss at plot level
# Track plots with insufficient data
plots_excluded <- daily_leaching_plot %>%
  group_by(treatment, year, plot) %>%
  summarise(n_obs = n(), .groups = "drop") %>%
  filter(n_obs < 2)

if (nrow(plots_excluded) > 0) {
  cat("Note:", nrow(plots_excluded), "plot(s) excluded due to insufficient data (<2 observations):\n")
  print(plots_excluded)
}

cum_leaching_plot_level <- daily_leaching_plot %>%
  group_by(treatment, year, plot) %>%
  group_modify(~ {
    df <- .x
    if (nrow(df) < 2) return(tibble())
    
    # Get date range for this year
    yr <- unique(df$year)
    date_range <- leaching_date_ranges %>% filter(year == yr)
    if (nrow(date_range) == 0) return(tibble())
    
    start_date <- date_range$min_date
    end_date <- date_range$max_date
    
    # Create full date sequence within measurement period
    all_dates <- tibble(date = seq.Date(start_date, end_date, by = "day"))
    
    # Join with observed data
    df_full <- all_dates %>%
      left_join(df %>% select(date, daily_loss), by = "date")
    
    # Interpolate loss values (rule = 1 means no extrapolation beyond observed range)
    valid_pts <- df %>% filter(!is.na(daily_loss) & daily_loss >= 0)
    n_pts <- nrow(valid_pts)
    
    if (n_pts >= 2) {
      loss_interp <- approx(
        x = valid_pts$date,
        y = valid_pts$daily_loss,
        xout = df_full$date,
        rule = 1,
        ties = "ordered"
      )$y
    } else if (n_pts == 1) {
      # Single point: use that value for all dates
      loss_interp <- rep(valid_pts$daily_loss[1], nrow(df_full))
    } else {
      loss_interp <- rep(0, nrow(df_full))
    }
    
    df_full %>%
      mutate(
        loss_interp = replace_na(loss_interp, 0),
        has_sample = !is.na(daily_loss) & daily_loss > 0
      ) %>%
      mutate(cum_loss = cumsum(loss_interp))
  }) %>%
  ungroup()

cat("\nPlot-level cumulative leaching data:", nrow(cum_leaching_plot_level), "observations\n")
cat("Unique plots:", length(unique(cum_leaching_plot_level$plot)), "\n")

# Step 4: Summarize across plots to get mean, SD, SE, and 95% CI
cum_leaching_summary <- cum_leaching_plot_level %>%
  group_by(treatment, year, date) %>%
  summarise(
    cum_loss_mean = mean(cum_loss, na.rm = TRUE),
    cum_loss_sd = sd(cum_loss, na.rm = TRUE),
    n_plots = n(),
    cum_loss_se = cum_loss_sd / sqrt(n_plots),
    t_crit = qt(0.975, df = pmax(n_plots - 1, 1)),
    cum_loss_ci = t_crit * cum_loss_se,
    has_sample = any(has_sample),
    .groups = "drop"
  ) %>%
  # Handle cases where SD is NA (single plot)
  mutate(
    cum_loss_ci = if_else(is.na(cum_loss_ci), 0, cum_loss_ci)
  )

cat("\nSummary statistics computed for", nrow(cum_leaching_summary), "treatment-year-date combinations\n")

# Get points where actual samples were taken for plotting
cum_leaching_points <- cum_leaching_summary %>% filter(has_sample)
```

# Daily Leaching Summary (for top panel)

```{r daily-leaching-summary}
#| label: daily-leaching-summary

# Build daily treatment means and SE for leaching
daily_leaching_summary <- daily_leaching_plot %>%
  group_by(treatment, year, date) %>%
  summarise(
    mean_loss = mean(daily_loss, na.rm = TRUE),
    se_loss = sd(daily_loss, na.rm = TRUE) / sqrt(sum(!is.na(daily_loss))),
    .groups = "drop"
  )

# Calculate daily significance tests between treatments
daily_leaching_significance <- leaching_data %>%
  filter(treatment %in% c("Sorghum", "Sorghum + Rye")) %>%
  mutate(
    year = lubridate::year(date),
    daily_n_loss_kgha = (total_n_loss_mg / 1e6) / plot_area_ha
  ) %>%
  filter(year %in% analysis_years) %>%
  group_by(year, date) %>%
  summarise(
    p_value = {
      sorghum_loss <- daily_n_loss_kgha[treatment == "Sorghum"]
      sorghum_rye_loss <- daily_n_loss_kgha[treatment == "Sorghum + Rye"]
      sorghum_loss <- sorghum_loss[!is.na(sorghum_loss)]
      sorghum_rye_loss <- sorghum_rye_loss[!is.na(sorghum_rye_loss)]
      if (length(sorghum_loss) >= 2 && length(sorghum_rye_loss) >= 2) {
        tryCatch({
          t_result <- t.test(sorghum_loss, sorghum_rye_loss)
          t_result$p.value
        }, error = function(e) NA_real_)
      } else {
        NA_real_
      }
    },
    .groups = "drop"
  ) %>%
  mutate(
    significant = p_value < 0.05,
    star_label = ifelse(significant & !is.na(p_value), "*", "")
  )

# Get max leaching values for star positioning
max_leaching_by_date <- daily_leaching_summary %>%
  group_by(year, date) %>%
  summarise(max_loss = max(mean_loss + se_loss, na.rm = TRUE), .groups = "drop")

# Combine significance data with position data
leaching_star_data <- daily_leaching_significance %>%
  left_join(max_leaching_by_date, by = c("year", "date")) %>%
  filter(star_label == "*") %>%
  mutate(star_y = max_loss * 1.1)

# Filter precipitation to match leaching measurement periods
daily_precip_leaching <- rain %>%
  transmute(date, year, precipmm) %>%
  filter(year %in% analysis_years) %>%
  left_join(leaching_date_ranges, by = "year") %>%
  filter(date >= min_date, date <= max_date) %>%
  select(date, year, precipmm)
```

# Create Figure 3 with Plot-Level Cumulative Uncertainty

```{r figure3-dual-axis}
#| label: fig-leaching-plotlevel-ci
#| fig-cap: "Daily nitrogen leaching and cumulative N loss with plot-level cumulative uncertainty (95% CI)"
#| fig-width: 13.3
#| fig-height: 7.5

# Calculate global maxima for consistent y-axes
global_max_loss <- max(daily_leaching_summary$mean_loss + 
                       replace_na(daily_leaching_summary$se_loss, 0), na.rm = TRUE)
global_max_precip_leaching <- max(daily_precip_leaching$precipmm, na.rm = TRUE)
global_max_cum_loss <- max(cum_leaching_summary$cum_loss_mean + 
                           cum_leaching_summary$cum_loss_ci, na.rm = TRUE)

# Scale precipitation to fit on loss scale, positioned from top down
global_precip_scale_factor_leaching <- global_max_loss * 0.4 / global_max_precip_leaching
global_plot_top_leaching <- global_max_loss * 1.1

create_leaching_dual_axis_plot <- function(year_val, is_right_panel = FALSE) {
  # Filter data for the specific year
  leaching_year <- daily_leaching_summary %>% filter(year == year_val)
  precip_year <- daily_precip_leaching %>% filter(year == year_val)
  star_year <- leaching_star_data %>% filter(year == year_val)
  cum_year <- cum_leaching_summary %>% 
    filter(year == year_val) %>%
    rename(Treatment = treatment)
  cum_pts <- cum_leaching_points %>% 
    filter(year == year_val) %>%
    rename(Treatment = treatment)

  # Full-year limits (force Jan 1 → Dec 31)
  year_start <- as.Date(sprintf("%d-01-01", year_val))
  year_end <- as.Date(sprintf("%d-12-31", year_val))

  # Daily leaching plot with precipitation
  daily_plot <- ggplot() +
    # Precipitation bars (from top down)
    geom_rect(data = precip_year,
              aes(xmin = date - 0.5, xmax = date + 0.5,
                  ymin = global_plot_top_leaching - precipmm * global_precip_scale_factor_leaching,
                  ymax = global_plot_top_leaching),
              fill = "#377EB8", alpha = 0.7) +
    # Daily leaching points
    geom_point(data = leaching_year,
               aes(x = date, y = mean_loss, color = treatment),
               size = 2) +
    geom_errorbar(data = leaching_year,
                  aes(x = date, ymin = mean_loss - se_loss, 
                      ymax = mean_loss + se_loss, color = treatment),
                  width = 0.2, alpha = 0.5) +
    # Significance stars
    geom_text(data = star_year,
              aes(x = date, y = star_y, label = star_label),
              color = "black", size = 8) +
    # Scales and styling
    scale_color_treatments() +
    guides(color = "none") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b",
                 limits = c(year_start, year_end)) +
    scale_y_continuous(
      name = if (!is_right_panel) expression("Daily N Loss (kg N ha"^-1*" day"^-1*")") else "",
      limits = c(0, global_plot_top_leaching),
      sec.axis = sec_axis(~ (global_plot_top_leaching - .) / global_precip_scale_factor_leaching,
                          name = if (is_right_panel) "Daily Precipitation (mm)" else "")
    ) +
    theme_publication() +
    theme(
      legend.position = "none",
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.y = if (is_right_panel) element_blank() else element_text(),
      axis.ticks.y = if (is_right_panel) element_blank() else element_line(),
      axis.title.y = if (is_right_panel) element_blank() else element_text(),
      axis.text.y.right = if (is_right_panel) element_text(color = "#377EB8") else element_blank(),
      axis.ticks.y.right = if (is_right_panel) element_line() else element_blank(),
      axis.title.y.right = if (is_right_panel) element_text(color = "#377EB8") else element_blank()
    ) +
    labs(title = paste("", year_val), x = "") +
    geom_hline(yintercept = 0, linetype = "solid", alpha = 0.3)

  # Cumulative leaching plot with plot-level CI ribbons
  cumulative_plot <- ggplot(cum_year, 
                            aes(x = date, y = cum_loss_mean, color = Treatment)) +
    geom_ribbon(
      aes(ymin = pmax(cum_loss_mean - cum_loss_ci, 0), 
          ymax = cum_loss_mean + cum_loss_ci, 
          fill = Treatment),
      alpha = 0.2, linewidth = 0
    ) +
    geom_line(linewidth = 1.1) +
    geom_point(data = cum_pts, 
               aes(x = date, y = cum_loss_mean, color = Treatment), 
               size = 1.8) +
    scale_color_treatments() +
    scale_fill_treatments() +
    scale_x_date(date_breaks = "1 month", date_labels = "%b",
                 limits = c(year_start, year_end)) +
    scale_y_continuous(
      name = if (!is_right_panel) expression("Cumulative N Loss (kg N ha"^-1*")") else "",
      limits = c(0, global_max_cum_loss)
    ) +
    labs(x = "Month") +
    theme_publication() +
    theme(
      legend.position = "none",
      axis.text.y = if (is_right_panel) element_blank() else element_text(),
      axis.ticks.y = if (is_right_panel) element_blank() else element_line(),
      axis.title.y = if (is_right_panel) element_blank() else element_text()
    )

  # Combine daily and cumulative plots vertically
  (daily_plot / cumulative_plot) +
    patchwork::plot_layout(heights = c(1.2, 1))
}

# Create plots for both years
leach_2023 <- create_leaching_dual_axis_plot(2023, is_right_panel = FALSE)
leach_2024 <- create_leaching_dual_axis_plot(2024, is_right_panel = TRUE)

# Combine plots side by side
figure3 <- (leach_2023 | leach_2024) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom", 
        legend.justification = "center",
        legend.box.just = "center")

figure3
```

# Save Figure

```{r save-figure}
#| label: save-figure

ggsave(
  filename = "figures/figure3_drainage_cumulative_plotlevelCI.png",
  plot = figure3,
  width = 174,
  height = 174,
  units = "mm",
  dpi = 600,
  bg = "white"
)

cat("Figure saved to figures/figure3_drainage_cumulative_plotlevelCI.png\n")
cat("Dimensions: 174 mm × 174 mm @ 600 dpi\n")
```

# Summary

This figure uses a more statistically appropriate uncertainty method for cumulative N loss:

1. **Plot-level computation**: Cumulative N loss is computed for each individual plot
   by interpolating daily losses between measurement dates and summing over time.

2. **Between-plot variability**: At each date, cumulative loss values are summarized
   across plots to compute:
   - Mean cumulative N loss
   - Standard deviation across plots
   - Standard error (SD / √n)
   - 95% CI using t-critical value (t × SE)

3. **Visualization**: The ribbon represents the 95% CI from between-plot variability
   in cumulative N loss, which is a more appropriate measure of uncertainty than
   propagating daily SEs through the cumulative sum.
