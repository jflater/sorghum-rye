---
title: "Sorghum and Rye Project Figures"
format: html
---

# Interpolate Flux

```{r}
# Hokusai-inspired color palette
hokusai_colors <- c(
  primary_blue = "#2B4B72",    # deep wave blue
  secondary_blue = "#A5CAD2",  # foam blue
  accent_blue = "#1A3B57",     # dark sea blue
  sand = "#E8DCC4",           # beach/paper color
  brown = "#714C36",          # wood block brown
  cloud_grey = "#B7B5B3",     # storm cloud grey
  mountain = "#464A4F"        # Mount Fuji grey
)

# Create theme function
theme_hokusai <- function(base_size = 12) {
  theme_minimal(base_size = base_size) %+replace%
    theme(
      # Background elements
      panel.background = element_rect(fill = "#F9F6ED", color = NA),  # light sand color
      plot.background = element_rect(fill = "#F9F6ED", color = NA),
      
      # Grid lines
      panel.grid.major = element_line(color = alpha("#B7B5B3", 0.2)),
      panel.grid.minor = element_blank(),
      
      # Text elements
      text = element_text(color = hokusai_colors["mountain"]),
      axis.text = element_text(color = hokusai_colors["mountain"]),
      axis.title = element_text(color = hokusai_colors["mountain"], face = "bold"),
      plot.title = element_text(color = hokusai_colors["mountain"], 
                              face = "bold", 
                              size = base_size * 1.2),
      
      # Facet labels
      strip.text = element_text(color = hokusai_colors["mountain"],
                              face = "bold",
                              size = base_size),
      strip.background = element_rect(fill = alpha(hokusai_colors["secondary_blue"], 0.2)),
      
      # Legend
      legend.background = element_rect(fill = "#F9F6ED"),
      legend.key = element_rect(fill = "#F9F6ED"),
      
      # Other
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing = unit(2, "lines")
    )
}

# Create a scale for the treatment colors using the Hokusai palette
scale_color_hokusai_d <- function() {
  scale_color_manual(
    values = c(
      "Sorghum" = "#714C36",         # brown
      "Sorghum + Rye" = "#2B4B72",   # deep blue
      "Corn" = "#1A3B57",            # dark blue
      "Soy" = "#B7B5B3"             # grey
      # Add any other treatments that appear in your data
      # Make sure the names match EXACTLY
      # "Treatment Name" = "hex color"
    )
  )
}

scale_fill_hokusai_d <- function() {
  scale_fill_manual(
    values = c(
      "Sorghum" = "#714C36",         # brown
      "Sorghum + Rye" = "#2B4B72",   # deep blue
      "Corn" = "#1A3B57",            # dark blue
      "Soy" = "#B7B5B3"             # grey
      # Add any other treatments that appear in your data
      # Make sure the names match EXACTLY
      # "Treatment Name" = "hex color"
    )
  )
}


```
```{r}
library(tidyverse)
library(zoo)
library(lubridate)
library(janitor)
```
# Table 1
# Table 2
Start with reading in the date that was cleaned in the 'scripts/clean_soil.R'
```{r}
df <- read_csv("data/clean_flux.csv")  %>% 
  clean_names() %>%
  rename(date = year_month_day) 

trt <- read_csv("data/metadata/plot_treatments.csv") %>% 
  clean_names()  %>% 
  # add leading zero to plot numbers
  mutate(plot = str_pad(plot, width = 2, side = "left", pad = "0")) %>%
  select(!growing_season)

# compare columns
compare_df_cols(df, trt)
```

# Plot Treatments

```{r}
trt_2023 <- trt %>%
  filter(date == "2023-07-01")

trt_2024 <- trt %>%
  filter(date == "2024-07-01")
```

A barplot of the flux data over time facted by plot and RowvsInterrow

```{r}
trt_year <- bind_rows(
  trt_2023 %>% mutate(year = 2023),
  trt_2024 %>% mutate(year = 2024)
) %>% select(plot, year, treatment)

df <- df %>%
  mutate(plot = str_pad(plot, width = 2, pad = "0"),
         year = year(date)) %>%
  left_join(trt_year, by = c("plot", "year"))
```

```{r}
head(df)
summary(df)
table(df$treatment, useNA = "ifany")
df %>% count(year, plot)
df %>% filter(is.na(treatment))
anti_join(df, trt_2023 %>% mutate(year = 2023) %>% select(plot, year), by = c("plot", "year"))
anti_join(df, trt_2024 %>% mutate(year = 2024) %>% select(plot, year), by = c("plot", "year"))
```

```{r}
# sanity checks
table(df$treatment, useNA = "ifany")
range(df$date, na.rm = TRUE)

df %>%
  filter(!is.na(treatment)) %>%
  group_by(plot, rowvs_interrow, treatment, date) %>%
  summarise(n = sum(!is.na(gnha_day_no_negative)), .groups = "drop") %>%
  count(n) %>% arrange(n)
```

```{r}
# prepare daily summary per treatment
daily_summary <- df %>%
  filter(!is.na(treatment)) %>%
  group_by(treatment, date) %>%
  summarise(
    mean_flux = mean(gnha_day_no_negative, na.rm = TRUE),
    se_flux   = sd(gnha_day_no_negative, na.rm = TRUE) / sqrt(sum(!is.na(gnha_day_no_negative))),
    .groups = "drop"
  )

# time-series with ribbon (one panel per plot, columns = row_vs_interrow)
ggplot(daily_summary, aes(x = date, y = mean_flux, fill = treatment)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ treatment) +
  scale_x_date(date_breaks = "1 day", date_labels = "%b %d") +
  labs(x = "Date", y = "GNHA Flux (g N/mÂ²/day)", fill = "Treatment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 7))
```
```{r}
# 1) daily means (no SE yet)
daily_summary <- df %>%
  filter(!is.na(treatment)) %>%
  mutate(date = as.Date(date), year = lubridate::year(date)) %>%
  group_by(plot, rowvs_interrow, treatment, year, date) %>%
  summarise(mean_flux = mean(gnha_day_no_negative, na.rm = TRUE), .groups = "drop")

# 2) distinct groups to iterate
groups <- daily_summary %>%
  distinct(plot, rowvs_interrow, treatment, year) %>%
  arrange(plot, rowvs_interrow, treatment, year)

# 3) iterate per group (explicit, easy to debug)
library(purrr)
interp <- pmap_dfr(
  groups,
  function(plot, rowvs_interrow, treatment, year) {
    sub <- daily_summary %>%
      filter(plot == !!plot, rowvs_interrow == !!rowvs_interrow, treatment == !!treatment, year == !!year) %>%
      arrange(date)

    start <- as.Date(paste0(year, "-01-01"))
    end   <- as.Date(paste0(year, "-12-31"))
    days  <- seq(start, end, by = "day")

    if (nrow(sub) == 0 || all(is.na(sub$mean_flux))) {
      mean_lin <- rep(NA_real_, length(days))
    } else {
      mean_lin <- approx(
        x = as.numeric(sub$date[!is.na(sub$mean_flux)]),
        y = sub$mean_flux[!is.na(sub$mean_flux)],
        xout = as.numeric(days),
        rule = 2, ties = "ordered"
      )$y
    }

    tibble(
      plot = plot,
      rowvs_interrow = rowvs_interrow,
      treatment = treatment,
      year = year,
      date = days,
      mean_flux_lin = mean_lin
    )
  }
)

# 4) aggregate by treatment+year and compute SE now (on interpolated daily values)
agg_by_trt_year <- interp %>%
  group_by(treatment, year, date) %>%
  summarise(
    n_plots = sum(!is.na(mean_flux_lin)),
    mean_flux = mean(mean_flux_lin, na.rm = TRUE),
    se_flux = ifelse(n_plots > 1, sd(mean_flux_lin, na.rm = TRUE) / sqrt(n_plots), NA_real_),
    .groups = "drop"
  )
```

```{r}
# Create publication-quality aggregated plot
ggplot(agg_by_trt_year, 
       aes(x = date, y = mean_flux, color = treatment)) +
  # Add ribbons for SE
  geom_ribbon(
    aes(ymin = mean_flux - se_flux, 
        ymax = mean_flux + se_flux,
        fill = treatment),
    alpha = 0.2, 
    color = NA
  ) +
  # Add lines and points
  geom_line(linewidth = 1) +
  geom_point(size = 2, alpha = 0.7) +
  # Split by year but keep treatments together
  facet_grid(. ~ year, scales = "free_x", space = "free_x") +
  # Custom colors
  scale_color_manual(
    values = c(
      "Sorghum" = "#D2B48C",
      "Sorghum + Rye" = "#8B4513",
      "Corn" = "#fda500",
      "Soy" = "#E9967A"
    )
  ) +
  scale_fill_manual(
    values = c(
      "Sorghum" = "#D2B48C",
      "Sorghum + Rye" = "#8B4513",
      "Corn" = "#fda500",
      "Soy" = "#E9967A"
    )
  ) +
  # Axis formatting
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b",
    expand = expansion(mult = 0.02)
  ) +
  # Labels
  labs(
    x = "Month",
    y = expression("Daily N"[2]*"O Flux (g N ha"^"-1"*")"),
    color = "Treatment",
    fill = "Treatment"
  ) +
  # Theme customization
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "bottom",
    legend.box = "horizontal",
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "lines"),
    strip.text = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
``` 

```{r}
# First, mark which days had actual measurements
actual_days <- daily_summary %>%
  select(treatment, date) %>%
  distinct() %>%
  mutate(measured = TRUE)

# Add this information to the aggregated data
agg_plot_data <- agg_by_trt_year %>%
  left_join(actual_days, by = c("treatment", "date")) %>%
  mutate(measured = replace_na(measured, FALSE))

# Example usage for your plot:
ggplot(agg_plot_data, aes(x = date, y = mean_flux, fill = treatment)) +
  geom_col(aes(alpha = measured), width = 1) +
  facet_wrap(~ treatment, ncol = 1, scales = "free_y") +
  scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b",
    expand = expansion(mult = 0.02)
  ) +
  labs(
    x = "Month",
    y = expression("Daily N"[2]*"O Flux (g N ha"^"-1"*")"),
    alpha = "Measured"
  ) +
  scale_fill_hokusai_d() +
  theme_hokusai(base_size = 14) 
```